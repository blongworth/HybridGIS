---
title: "Dual Bellows Tests"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

Load libraries and functions

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(amstools)
source('~/Projects/HybridGIS/R/HGISFunctions.R')
```

## Leak checker flow rates

Tested flow rates using helium leak checker.

### First test 65 and 100um PEEK capillaries

Tests on 07/31/2017. Used dual bellows sample inlet block. Attached capillary to sample-mass spec outlet (valve SM). Loaded Helium at SI, measured pressure with inlet gauge. Used two PEEK capillaries- 65um and 100um ID x 158cm long.

Presures in mBar, leak rate in mbar l/s.

```{r}
r <- c(5E-5, 5E-5, 5E-5, 3.3E-5, 3.3E-5, 3.3E-5)
press <- c(18, 30, 60, 18, 60, 103)
leakrate <- c(6.3E-7, 3.8E-6, 1.8E-5, 5.7E-7, 8.8E-6, 2.5E-5)
data <- data.frame(r, press, leakrate) 

#convert leak rate to Pa m3/s
data <- mutate(data, 
               leakrate = leakrate * 100 / 1000, # convert to Pa m3 s-1
                sccm = leakrate / 0.0016, # convert to sccm
                 co2sccm = sccm * 1.49E-5/1.90E-5, # co2/He viscosity
                 flow = co2sccm * 1E3, # convert to ul/m
                 press = press / 10) # convert to kPa
               
ggplot(data, aes(press, flow, color = as.factor(r))) + 
  geom_line() + 
  geom_point()
```


### 100um capillary, second test

Second test of 100um capillary 17-10-2017.

```{r}
r <- 5E-5
press <- c(0, 35, 50, 75, 100, 140, 159, 190, 222, 20, 8, 0)

#press <- press/10 # convert to kPa
leakrate <- c(3.6E-11, 7.2E-7, 1.5E-6, 3.1E-6, 5.1E-6, 9.4E-6, 1.2E-5, 1.5E-5, 2.2E-5, 2.2E-7, 1.5E-8,1.4E-9)
  
data <- data.frame(r, press, leakrate) 

data <- mutate(data,
                sccm = leakrate / 0.0016, # convert to sccm
                 co2sccm = sccm * 1.49E-5/1.90E-5, # co2/He viscosity
                 flow = co2sccm * 1E3, # convert to ul/m
                 press = press / 10,
                 calflow = flowcalc(press, 5E-5, 1.49E-5, 1.58),
                 corcalflow = flowcalc(press, 2.5E-5, 1.49E-5, 1.58) ) # convert to kPa

ggplot(data, aes(press, flow)) + geom_line() + geom_point()
```

Looks like calculated flows don't match up with measured. Is diameter of capillary wrong? Using a diameter of 50um in poiselle's gives better numbers...

```{r}
ggplot(data, aes(flow, calflow)) + geom_line() + geom_point()
ggplot(data, aes(flow, corcalflow)) + geom_line() + geom_point()
```

### Glass capillary

Leak checker test of 100um x 178mm glass capillary 20-10-2017.

```{r}
r <- 5E-5
press <- c(0, 32, 64, 80, 110, 121, 150, 15, 10, 4)
leakrate <- c(2E-9, 1.1E-6, 2.8E-6, 3.7E-6, 6.1E-6, 7.5E-6, 1.1E-5, 4.5E-7, 2.7E-7, 8.5E-8)
  
data <- data.frame(r, press, leakrate) 

data <- mutate(data,
                sccm = leakrate / 0.0016, # convert to sccm
                 co2sccm = sccm * 1.49E-5/1.90E-5, # co2/He viscosity
                 flow = co2sccm * 1E3, # convert to ul/m
                 press = press / 10, # convert to kPa
                 calflow = flowcalc(press, 5E-5, 1.49E-5, 1.78))

ggplot(data, aes(press, flow)) + 
  geom_line() + 
  geom_point() + 
  ggtitle("100um Glass Capillary, flow vs pressure")
ggplot(data, aes(calflow, flow)) + 
  geom_line() + 
  geom_point() + 
  ggtitle("100um Glass Capillary, measured vs predicted flow")
```

## Source flow tests

Tests on 10/10/2017. Same conditions as above. Inlet to source, measured source pressure with source iso GV closed. No discharge observed for any capillary.

### Source pressure vs supply pressure

```{r}
r <- 5E-5
press <- c(10, 25, 55, 112, 205, 312, 408, 500, 607, 702, 802, 1000)
source <- c(7.1E-8, 7.2E-8, 7.6E-8, 8.5E-8, 1.6E-7, 6.2E-7, 1.2E-6, 1.9E-6, 2.8E-6, 3.8E-6, 4.8E-6, 7.3E-6)
data <- data.frame(r, press, source) 

data <- mutate(data,
               press = press/10, # convert to kPa
               flow = flowcalc(press, 5E-5, 1.49E-5, 1.58)
)

ggplot(data, aes(press, source)) + geom_line() + geom_point()
```


Calculated flow vs source pressure. Something fishy here.

```{r}
ggplot(data, aes(flow, source)) + geom_line() + geom_point()
```

If the diameter of the capillary is adjusted to 50um, things look more realistic...
```{r}
data <- mutate(data, flow = flowcalc(press, 2.5E-5, 1.49E-5, 1.58))
ggplot(data, aes(flow, source)) + geom_line() + geom_point()
```

### Beam tests 11/14/17

Used black PEEK capillary. 
```{r}
lpdata <- read.csv("../Data/14Nov2017LPtest.csv", skip = 4) %>%
  mutate(supply = supply / 10,
         source = source * 1E-7,
         flow = flowcalc(supply, 2E-5, 1.49E-5, 1.58))
         
ggplot(lpdata, aes(supply, current)) + 
  geom_smooth() + geom_point() +
  labs(x = "Inlet pressure (kPa)", y = "C12 Current")
ggplot(lpdata, aes(supply, source)) + 
  geom_smooth() + geom_point() +
  labs(x = "Inlet pressure (kPa)", y = "Source pressure (Pa)")
ggplot(lpdata, aes(flow, source)) + 
  geom_smooth() + geom_point() +
  labs(x = "Flow (ul/min)", y = "Source pressure (Pa)")
ggplot(lpdata, aes(flow, current)) + geom_smooth() + geom_point() +
  labs(x = "Flow (ul/min)", y = "Source current (uA)")
ggplot(lpdata, aes(source, current)) + geom_smooth(span = 1) + geom_point() +
  labs(x = "Source pressure (Torr)", y = "Source current (uA)")
         
```

## 04/25/2018 - Testing bellows compression

Wired up stepper drives. Tested currents and flows with black PEEK capillary
(nominally 100um id). Source works fine after cleaning clog from delivery tube
at last source cleaning. Ran scan of inlet pressures, saw best currents at
~600mbar. Reduced pressure to 300mbar, closed SF, used bellows to return flow
to optimum.

inletp in mbar, sourcep in Torr, current in uA.

```{r}
# load data
beldat <- read_csv("../Data/bellowsApr2518.csv")
beldat
```

```{r}
belopen <- beldat %>% filter(bellows == 0)

ggplot(belopen, aes(inletp, sourcep)) + 
    geom_point() + 
    geom_line()
```

Inlet pressure/source pressure relationship is about the same as last time. Still way more than calculated inlet pressure for a given source pressure. Capillary pinching at the swagelok connection or bad calculations?

Based on later alignment testing, flows for good current are reduced by about 3x with better alignment of delivery arm with target.

```{r}
ggplot(belopen, aes(sourcep, c12cur)) +
  geom_line() + geom_point() +
  labs(x = "Source pressure (Torr)", y = "Source current (uA)")
```

Looks like we have about the same source pressure/current optima as before.

```{r}

bellows <- beldat %>% filter(is.na(inletp) | inletp == 300)


ggplot(bellows, aes(bellows, c12cur)) +
  geom_smooth(method = "lm") + geom_point() +
  labs(x = "Bellows position (0-120k)", y = "Source current (uA)")
```

As expected, source pressure and current follow bellows position, such that bellows position is proportional to inlet pressure.

## 05/23/2018 - Bellows with test samples

Initially tried 2m x 100um glass capillary. There were two sparks with two different capillaries. Both sparks broke capillary at what is presumably spark exit point. Later open split tests with glass capillaries did not have sparking issue. Three differences with open split: 

1. Pressure. Open split should be at higher pressure along cap length.
2. Open split capillary is terminated in grounded SS bulkhead connector at cage.
3. A teflon jacket was added to the capillary inside the cage.


Load data from tests & runs

Ran OX-I's and OX-II's from bellows end archive tubes. All ~100umol. 

4 samples:
OX-I GS-9394 Pos 15
OX-I?
OX-II GS-10051 Pos 17
C-1 HY-31410 Pos 18

```{r}

data <- readResfile("/mnt/shared/USAMS/Results/2018 Results/USAMS052318RHIGS.txt") %>% mungeResfile()

sdata <- data %>% group_by(Sample.Name) %>%
  summarise(mean = mean(cor1412he),
            sd = sd(cor1412he),
            se = se(cor1412he),
            psd = sd(cor1412he)/mean,
            pse = se/mean,
            interr = 1/sqrt(sum(CntTotGT)),
            N = n()) %>%
  mutate(normfm = mean/9.7150433 * 1.0398)
sdata
```


```{r}
p <- ggplot(data, aes(ts, X14.12he, group=Sample.Name))

p + geom_point()
p + geom_boxplot()
```
```{r}

```

## 05/30/2018 - Helium Dilution tests

Cleaned and reloaded sample wheel:
2x ceylon, 2x ox-I, 8 gas cathodes.

Added needle valve for UHP helium to inlet. Using turbopump instead of cryo. Base pressures are about 1E-6 initially, 6E-7 after a few hours, and 4E-7 overnight. Cryo base pressures are around 1E-7.

Basic procedure:

1. Admit sample to inlet, measure pressure.
2. Freeze sample to CF.
3. Admit He to inlet to give desired dillution
4. Close SF
5. Warm sample
6. Adjust bellows for best current
7. Run sample

### Flow tests



Ran live tank gas and an OX-II breakseal.

Load data from tests & runs

```{r}

data <- readResfile("/mnt/shared/USAMS/Results/2018 Results/USAMS053018R.txt") %>%   
  mungeResfile()
data <- data %>%
  filter(Sample.Name != "Ceylon",
         ts < "2018-05-31")

data %>% group_by(Sample.Name) %>%
  summarise(mean = mean(cor1412he),
            sd = sd(cor1412he))

p <- ggplot(data, aes(ts, cor1412he, group=Sample.Name))

p + geom_point()
p + geom_boxplot()
```

### Data runs

```{r}

```

## Jun 6, 2018 - Flow tests

Lowered arm by a full turn, moved actuator clevis down by one turn. Some additional alignment testing: Move arm, test current, repeat. Best flow/current- 9uA at source pressure of 7E-7 Torr.

Reterminated black PEEK capillary.

Calc for best flow:


```{r}
r <- 5E-5
u <- 1.49E-5
x <- 1.58
flowcalc(20, r, u, x)
```
```{r}
flowdat <- read.csv("../Data/DIflowJun618.csv")


ggplot(flowdat, aes(source, current)) +
  geom_line() + geom_point() +
  labs(x = "Source pressure (Torr)", y = "Source current (uA)")
str(flowdat)
```