---
title: "Open Split Tests"
output:
  html_document:
    df_print: paged
  pdf_document: default
---


```{r, message=FALSE, warning=FALSE}
# Load libraries and functions
library(tidyverse)
library(amstools)
library(here)
source(here('R/HGISFunctions.R'))
```

Development notes for using the HGIS with an open split. Intention is to use
with gasbench for carbonates and/or large co2 samples.

## Capillary parameters

Calculate ideal capillary to provide ~7.5uL/min at atmospheric pressure.

### Short capillary at 1 atm

40um capillary

```{r}
r <- 2E-5
u <- 1.49E-5
x <- 3.5
flowcalc(100, r, u, x)
```
```{r}
r <- 2E-5
u <- 1.49E-5
x <- 2
flowcalc(100, r, u, x)
```
50um capillary
```{r}
r <- 2.5E-5
u <- 1.49E-5
x <- 3
flowcalc(100, r, u, x)
```
```{r}
r <- 2.5E-5
u <- 1.49E-5
x <- 7
flowcalc(100, r, u, x)
```

## First tests

### DATE?

Tried a bunch of capillary combinations. Other than initial pressure burst when
opening or closing HGIS valve, couldn't see any source pressure changes or beam
current. We believe the source end of the stainless capillary was clogged by
cesium residue. 

Cleaned capillary end at next source cleaning, first with kimwipe and water,
then with isopropanol. Lots of black crud. Confirmed open passage by blowing N2
through capillary into cup of isopropanol to observe bubbles.

### May 23, 2018

Tried 3m of 50um glass capillary. Insulated from source to cage with
teflon tubing as outer jacket. No problems with sparks.

Low currents, even when cutting capillary down to 2m. Either steel
capillary is partially clogged or tip is not making good seal with target.

### May 31, 2018 - He Dilution

Open split set up with helium dilution. Using 100um glass capillary. ~50cm
source to bulkhead with teflon jacket, 285cm bulkhead to open split. 

Table: Source pressures

Condition     Torr  
---------     ---- 
base w/cryo   1E-7  
base w/turbo  4E-7  
capillary     36E-7 


#### Dilution and current

Flow and current tests with varying capillary and dilution. Flows in mL/min,
pressure in Torr, current in uA. Replumbed helium to panel open split with
needle valve partway through to better control flow. Live CO2 set to 10mL/min.

```{r}
osdil <- tibble(
  co2 = c(18, 18, 18, 18, 18, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10),
  caplen = c(322, 322, 322, 322, 322, 322, 322, 322, 322, 322, 
             322, 322, 230, 230, 177, 177),
  helium = c(0, 100, 200, 300, 500, 0, 10, 20, 30, 50, 
             100, 200, 100, 200, 100, 50),
  sourcevac = c(7.5E-6,1.5E-6,1E-6,8.5E-7,8.4E-7,7.5E-7, 3.3E-6, 2.3E-6, 
                1.9E-6, 1.5E-6, 1E-6, 9.3E-7, 1.1E-6, 1.4E-6, 1.7E-6, 2.3E-6),
  current = c(7, 4, 3, 2, 2, 6.7, 5, 4, 3.5, 2.6, 1.6, 1.3, 1.3, 1.8, 2.3, 3.6)
)

write.csv(osdil, here("Data/dillution.csv"))
osdil <- mutate(osdil, ratio = helium/co2)
osdil
```

```{r}
filter(osdil, co2 == 18) %>%
  ggplot(aes(ratio, current)) +
    geom_line() + 
    ggtitle("Current vs dillution ratio, CO2 at 18ml/min")
filter(osdil, co2 == 10, caplen == 322) %>%
  ggplot(aes(ratio, current)) +
    geom_line() +
    ggtitle("Current vs dillution ratio, CO2 at 10ml/min")
```


#### Test Acquisitions

Ran 4 test Acquisitions with open split: pure CO2, pure dead CO2, diluted
live, diluted dead. Data are 14/12 ratio with a 13C correction applied. NormFm is values normalized to the ratio of the solid OX-I.

```{r}
# Load data
data <- readResfile(here("Data/USAMS053018R.txt"))
data <- mungeResfile(data)
sdata <- data %>% 
  filter(Sample.Name != "Ceylon") %>%
  group_by(Sample.Name) %>%
  summarise(mean = mean(cor1412he),
            sd = sd(cor1412he),
            se = se(cor1412he),
            psd = sd(cor1412he)/mean,
            pse = se/mean,
            interr = 1/sqrt(sum(CntTotGT)),
            N = n()) %>%
  mutate(normfm = mean/9.8669966 * 1.0398)
sdata
```


```{r}
data %>% 
  mutate(Fm = ifelse(cor1412he > 5, "modern", "dead")) %>% 
ggplot(aes(Sample.Name, cor1412he)) +
  geom_boxplot() +
  facet_grid(Fm~., scales = "free_y")
```

Summary data for undiluted live gas. 

```{r}
ospure <- filter(data, Sample.Name == "LiveGas")

ggplot(ospure, aes(ts, cor1412he)) + geom_point()
summary(ospure$cor1412he)

mean(ospure$cor1412he)
sd(ospure$cor1412he)
```

Not sure where the data is for the following statement:

Load pos 7 (new target). Initial current 20uA (lots of LE13C - hydrides).
Down to 2uA in 2 min. 10mL/min of pure modern CO2 into open split.
Acquired 60 x 30s blocks.



### 2019-05-31 - startup tests

Reinstalled gas delivery arm after cleaning and polishing ball end.

Using 50um x .5m capillary source to cage and 50um x 2.5m to open split. Open split flowing modern co2 at 10mL/min. Using same targets and wheel as last time. Surprisingly good performance, including no-gas base current, hgis current and solid samples.

Currents up to 15uA, source vac 8.3E-7 with gas on, 5.5E-7 with gas off.


### 2019-06-03 - dillution tests

Spun up inlet turbopump. Looked at dilution and current.

```{r}
dil <- tibble(
  CO2 = c(10, 10, 10, 10, 10),
  Tot = c(10, 20, 30, 43.5, 10),
  vac = c(1.24E-6, 9.52E-7, 8.3E-7, 8E-7, 1.07E-6),
  cur = c(10, 9.6, 7, 5, 10)
) %>% 
  mutate(He = Tot - CO2,
         ratio = He/CO2)
dil
```
```{r}
ggplot(dil, aes(ratio, cur)) +
  geom_line() +
  ggtitle("Current vs dillution ratio, CO2 at 10ml/min")
```

### 2020-10-06 Dilution vs Ratio

Testing effect of helium dilution on ratio. Used remaining targets on USAMS012220. Reterminated capillaries at cage wall and at open split.

Used positions 7-10, results in USAMS012220. Low currents: ~6uA pure CO2, 3uA diluted.

```{r}
# Load data
data <- readResfile(here("Data/USAMS012220R.txt"))
data <- mungeResfile(data)
sdata <- data %>% 
  filter(Sample.Name != "Ceylon") %>%
  group_by(Sample.Name) %>%
  summarise(mean = mean(cor1412he),
            sd = sd(cor1412he),
            se = se(cor1412he),
            psd = sd(cor1412he)/mean,
            pse = se/mean,
            interr = 1/sqrt(sum(CntTotGT)),
            N = n()) %>%
  mutate(normfm = mean/9.433353663 * 1.0398)
sdata
```


```{r}
data %>% 
  mutate(Fm = ifelse(cor1412he > 5, "modern", "dead")) %>% 
ggplot(aes(Sample.Name, cor1412he)) +
  geom_boxplot() +
  facet_grid(Fm~., scales = "free_y")
```

Looks like diluted and undiluted live gas have the same ratio.

### 2020-10-15 New wheel, low currents

Loaded a new wheel (USAMS101320) with 4 solid targets and 6 gas targets. Currents were low (3uA gas, 40uA solid) and didn't increase with tune, target position or gas arm position. Will clean source and try again.


### 2020-11-03 Continued dillution tests

Still very low currents, ~2uA for live CO2. Ran a dillution test anyway with positions 5-8 on USAMS101320. 

**Flows**

Gas   Flow
---   ----
live  10
dead  11.1
He    30.2

```{r}
data <- readResfile(here("Data/USAMS101320R.txt"))
data <- mungeResfile(data)
sdata <- data %>% 
  filter(Sample.Name != "Ceylon",
         as.Date(ts) == "2020-11-03") %>% #separate from later run by timestamp
  group_by(Sample.Name) %>%
  summarise(mean = mean(cor1412he),
            sd = sd(cor1412he),
            se = se(cor1412he),
            psd = sd(cor1412he)/mean,
            pse = se/mean,
            interr = 1/sqrt(sum(CntTotGT)),
            N = n()) %>%
  mutate(normfm = mean/9.905 * 1.0398)
sdata
```


```{r}
data %>% 
  filter(as.Date(ts) == "2020-11-03") %>% 
  mutate(Fm = ifelse(cor1412he > 5, "modern", "dead")) %>% 
ggplot(aes(Sample.Name, cor1412he)) +
  geom_boxplot() +
  facet_grid(Fm~., scales = "free_y")
```

### 2020-11-17 Dillution testing - back to good currents

Finally back to testing after figuring out current issue. Rerunning dilution test. Flows: live 11.6mL/min, dead 11.1, He 30.2. Pressures: cryo base 8E-8, turbo base 3E-7, w/live CO2 1.2E-6. Source producing ~8uA HE12C with live CO2. Data in USAMS101320.

Running positions 9 and 10 as 1:1 He dilutions of live and dead, respectively.

```{r}
data <- readResfile(here("Data/USAMS101320R.txt"))
data <- mungeResfile(data)
sdata <- data %>% 
  filter(Sample.Name != "Ceylon",
         as.Date(ts) == "2020-11-17") %>% #separate from earlier run by timestamp
  group_by(Sample.Name) %>%
  summarise(mean = mean(cor1412he),
            sd = sd(cor1412he),
            se = se(cor1412he),
            psd = sd(cor1412he)/mean,
            pse = se/mean,
            interr = 1/sqrt(sum(CntTotGT)),
            N = n()) %>%
  mutate(normfm = mean/9.747 * 1.0398)
sdata
```


```{r}
data %>% 
  filter(as.Date(ts) == "2020-11-17") %>% 
  mutate(Fm = ifelse(cor1412he > 5, "modern", "dead"),
         Dilution = case_when(str_ends(Sample.Name, "1") ~ "1:1",
                               str_starts(Sample.Name, "Dil") ~ "3:1",
                               TRUE ~ "pure"),
         Dilution = factor(Dilution, levels = c("pure", "1:1", "3:1"))) %>% 
ggplot(aes(Sample.Name, cor1412he, color = Dilution)) +
  geom_boxplot() +
  facet_grid(Fm~., scales = "free_y")
```
