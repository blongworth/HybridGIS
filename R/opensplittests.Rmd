---
title: "Open Split Tests"
output:
  html_document:
    df_print: paged
  pdf_document: default
---


```{r, message=FALSE, warning=FALSE}
# Load libraries and functions
library(tidyverse)
library(amstools)
library(here)
source(here('R/HGISFunctions.R'))
theme_set(theme_bw())
options(digits = 3)
```

Development notes for using the HGIS with an open split. Intention is to use
with gasbench for carbonates and/or large co2 samples.

# Capillary parameters

Calculate ideal capillary to provide ~7.5uL/min at atmospheric pressure.

## Short capillary at 1 atm

40um capillary

```{r}
r <- 2E-5
u <- 1.49E-5
x <- 3.5
flowcalc(100, r, u, x)
```
```{r}
r <- 2E-5
u <- 1.49E-5
x <- 2
flowcalc(100, r, u, x)
```
50um capillary
```{r}
r <- 2.5E-5
u <- 1.49E-5
x <- 3
flowcalc(100, r, u, x)
```
```{r}
r <- 2.5E-5
u <- 1.49E-5
x <- 7
flowcalc(100, r, u, x)
```


## 2018-04-10 - First tests

Tried a bunch of capillary combinations. Other than initial pressure burst when
opening or closing HGIS valve, couldn't see any source pressure changes or beam
current. We believe the source end of the stainless capillary was clogged by
cesium residue. 

Cleaned capillary end at next source cleaning, first with kimwipe and water,
then with isopropanol. Lots of black crud. Confirmed open passage by blowing N2
through capillary into cup of isopropanol to observe bubbles.

## 2018-05-23 First tests

Tried 3m of 50um glass capillary. Insulated from source to cage with
teflon tubing as outer jacket. No problems with sparks.

Low currents, even when cutting capillary down to 2m. Either steel
capillary is partially clogged or tip is not making good seal with target.

## 2018-05-31 - He Dilution

Open split set up with helium dilution. Using 100um glass capillary. ~50cm
source to bulkhead with teflon jacket, 285cm bulkhead to open split. 

### Flows

```{r}
flowcalc(100, r = 2.5E-5, u = 1.49E-5, l = 3.35)
```

This is way too high. I may have been using a 50um capillary for the tests.

### Pressures

Table: Source pressures

Condition     Torr  
---------     ---- 
base w/cryo   1E-7  
base w/turbo  4E-7  
capillary     36E-7 


### Dilution and current

Flow and current tests with varying capillary and dilution. Flows in mL/min,
pressure in Torr, current in uA. Replumbed helium to panel open split with
needle valve partway through to better control flow. Live CO2 set to 10mL/min.

```{r}
osdil <- read_csv(here("Data/2018-05-31_dillution.csv")) %>% 
  mutate(ratio = helium/co2)
osdil
```

```{r}
osdil %>% 
  filter(caplen == 322) %>% 
  ggplot(aes(ratio, current)) +
    geom_line() + 
    ggtitle("Current vs dillution ratio for 10 and 18 mL/m CO2") +
    facet_grid(co2 ~ .)
```


### Test Acquisitions

Ran 4 test Acquisitions with open split: pure CO2, pure dead CO2, diluted
live, diluted dead. Data are 14/12 ratio with a 13C correction applied. NormFm is values normalized to the ratio of the solid OX-I. There are also dual inlet samples on this wheel, filtered out by date. Positions are incorrect in file because wheel was advanced manually. Correct positions in notebook and fixed below. Added correct dillution factors below.

```{r}
data <- get_hgis_data(here("Data/USAMS053018R.txt"), 
                      as.Date(c("2018-05-30", "2018-05-31"))) %>% 
           filter(Pos %in% c(3,4) | as.Date(ts) == "2018-05-31") %>% 
           mutate(Pos = case_when(Sample.Name == "LiveGas" ~ 7,
                                  Sample.Name == "DeadGas" ~ 8,
                                  Sample.Name == "LiveGasHe" ~ 9,
                                  Sample.Name == "DeadGasHe" ~ 10,
                                  TRUE ~ as.numeric(Pos)),
                  dil_factor = case_when(Pos == 9 ~ (50.3 - 9.4)/9.4,
                                         Pos == 10 ~ (40 - 4.8)/4.8),
                  Num = ifelse(Pos %in% c(3, 4), "S", Num))

# Get mean ratio for solid OX-I and normalize data
stdrat <- mean(data$cor1412he[data$Num == "S"])
data <- mutate(data, normFm = norm_gas(cor1412he, stdrat))
                  
sum_hgis(data)
```


```{r}
plot_hgis(data)
```



## 2019-05-31 - startup tests

Reinstalled gas delivery arm after cleaning and polishing ball end.

Using 50um x .5m capillary source to cage and 50um x 2.5m to open split. Open split flowing modern co2 at 10mL/min. Using same targets and wheel as last time. Surprisingly good performance, including no-gas base current, hgis current and solid samples.

```{r}
flowcalc(pres = 100, r = 2.5E-5, u = 1.49E-5, l = 3.0)
```


Currents up to 15uA, source vac 8.3E-7 with gas on, 5.5E-7 with gas off.

No data recorded

## 2019-06-03 - dillution tests

Spun up inlet turbopump. Looked at dilution and current.

```{r}
dil <- tibble(
  CO2 = c(10, 10, 10, 10, 10),
  Tot = c(10, 20, 30, 43.5, 10),
  vac = c(1.24E-6, 9.52E-7, 8.3E-7, 8E-7, 1.07E-6),
  cur = c(10, 9.6, 7, 5, 10)
) %>% 
  mutate(He = Tot - CO2,
         ratio = He/CO2)
dil
```
```{r}
ggplot(dil, aes(ratio, cur)) +
  geom_line() +
  ggtitle("Current vs dillution ratio, CO2 at 10ml/min")
```


## 2020-09-10 Starting up HGIS

Solid run on pos 1:4 on USAMS012220.


## 2020-09-29 Dilution vs Ratio

Testing effect of helium dilution on ratio. Used remaining targets on USAMS012220. Reterminated capillaries at cage wall and at open split.

Used positions 7-10, results in USAMS012220. Low currents: ~6uA pure CO2, 3uA diluted. Flows: He 10, deadCO2 11, liveCO2 10.

```{r}
# Load data
data <- get_hgis_data(here("Data/USAMS012220R.txt"), 
                      as.Date(c("2020-09-10", "2020-09-29"))) %>% 
           mutate(dil_factor = ifelse(str_starts(Sample.Name, "Dil"), 1, 0), 
                  Num = ifelse(Pos == 7, "U", Num))
stdrat <- mean(data$cor1412he[data$Num == "S"])
data <- mutate(data, normFm = norm_gas(cor1412he, stdrat))
sum_hgis(data)
```


```{r}
plot_hgis(data)
```

Looks like diluted and undiluted live gas have the same ratio.

## 2020-10-15 New wheel, low currents

Loaded a new wheel (USAMS101320) with 4 solid targets and 6 gas targets. Currents were low (3uA gas, 40uA solid) and didn't increase with tune, target position or gas arm position. Will clean source and try again.


## 2020-11-03 Continued dillution tests

Still very low currents, ~2uA for live CO2. Ran a dillution test anyway with positions 5-8 on USAMS101320. 

**Flows**

Gas   Flow
---   ----
live  10
dead  11.1
He    30.2

```{r}
data <- get_hgis_data(here("Data/USAMS101320R.txt"), as.Date("2020-11-03"))
sum_hgis(data)
```


```{r}
plot_hgis(data)
```

## 2020-11-17 Dillution testing - back to good currents

Finally back to testing after figuring out current issue. Rerunning dilution test. Flows: live 11.6mL/min, dead 11.1, He 30.2. Pressures: cryo base 8E-8, turbo base 3E-7, w/live CO2 1.2E-6. Source producing ~8uA HE12C with live CO2. Data in USAMS101320.

Running positions 9 and 10 as 1:1 He dilutions of live and dead, respectively.

```{r}
data <- get_hgis_data(here("Data/USAMS101320R.txt"), as.Date("2020-11-17"))
sum_hgis(data)
```

Look at counts per second to think about needed acquisition time.

```{r}
data %>% group_by(Sample.Name) %>% 
  summarize(cps = mean(CntTotGT/(Cycles/10)))
```


```{r}
plot_hgis(data)
```

```{r}
data %>% filter(Pos %in% 5:10) %>% 
  ggplot(aes(he12C, normFm, color = Sample.Name)) +
  geom_point()
```

Doesn't seem to follow curves expected for a MBC with nearly live blank at about 1% of gas current.

## 2020-12-03 Blank tests

Ran a series of blank tests before exposing graphite samples or introducing live co2. 

```{r}
data <- get_hgis_data(here("Data/USAMS120320R.txt"), as.Date("2020-12-04"))
sum_hgis(data)
```



```{r}
plot_hgis(data)
```

### Modeling Blank

With these data we can start to think about modeling a mass balance, or more accurately, a current balance blank. It's not initally clear whether the blank comes from the target/source, dilluent helium, or a combination of the two.

```{r}
data %>% filter(Pos %in% 9:12) %>% 
  ggplot(aes(he12C, normFm, color = Sample.Name)) +
  geom_point()
```

```{r}
data %>% filter(Pos %in% 9:12) %>% 
  ggplot(aes(1/he12C, normFm, color = Sample.Name)) +
  geom_point()
```

TODO: Fit mass balance curve using currents
TODO: Use bottle gas to produce live/dead curves 
TODO: produce live/dead curves using helium dillution

## 2020-12-11 open split flow reduction

Testing reduced open split flows. Worked with flow controller (helium) and adjusted stops on live and dead co2 needle valves to allow lower flows. Tested for breakthrough by flowing helium through split and into source while blowing dead CO2 accross the opening of the split at ~10mL/min. CO2 seen in source somewhere between 100 and 300 uL/min. Hard to measure with this setup due to slow response time and lack of sensitivity of capillary/ion source. Need to try this with leak checker.

Reran blank tests at lower flows. Results seem as good or better than last week's tests at high flows. This may also be due to targets being more pumped down or burned in.

TODO: get flows from notes.

```{r}
data <- get_hgis_data(here("Data/USAMS120320R.txt")) %>% 
  filter(Pos %in% 1:4 | as.Date(ts) == "2020-12-11")
sum_hgis(data)
```


```{r}
plot_hgis(data)
```


```{r}
data %>% filter(Pos %in% 9:12) %>% 
  ggplot(aes(1/he12C, normFm, color = Sample.Name)) +
  geom_point()
```

## 2020-12-18 More testing of low open split flow rates

Tested open split breakthrough at low flows using leak checker. Measured helium flow through capillary using leak checker. Ran target blanks, dead and live samples at low flows. Started building double needle testbed.

### Leak checker flow rate

Connected cage-split capillary to leak checker. Base leak rate with capillary in air: 1.7E-9 mbarLs-1. Leak rate with helium in open split: 3.5E-4 mbarls-1.

### Leak checker breakthrough tests

Flowing dead CO2 through split. Flowing helium across mouth of split at 8mLmin-1.

```{r}
lc_breakthrough <- tribble(~co2, ~leakrate,
                          730, 6E-9,
                          735, 6.5E-9,
                          525, 7.9E-9,
                          178, 1.3E-7,
                          150, 2E-7,
                          0, 3E-6)
lc_breakthrough
ggplot(lc_breakthrough, aes(co2, leakrate)) + geom_line() + geom_point()
```

### Data acquisitions at low(er) flows

Source off base: 4E-8
Cryo base (HV + Ion): 6E-8
Turbo base: 2E-7

Set SRS to 10uA/V and 50nA/V for 12 and 13C.

Flows:

```{r}
flows <- tribble(~pos, ~Sample.Name, ~co2, ~he,
                10, "DeadGas", 270, 0,
                9, "DilDeadGas", 112, 288,
                8, "DilDeadGas6", 102, 0,
                8, "DeadGas", 102, 572-102,
                7, "HeliumBlank", 0, 572-102,
                7, "DilLiveGas6", 117, 576-117) %>% 
  mutate(dil_ratio = he/co2)
flows
```

        
```{r}
data <- get_hgis_data(here("Data/USAMS120320R.txt"), as.Date("2020-12-18"))
sum_hgis(data)
```


```{r}
plot_hgis(data)
```

```{r}
data %>% filter(Pos %in% 7:10) %>% 
  ggplot(aes(1/he12C, normFm, color = Sample.Name)) +
  geom_point()
```
## 2021-01-08 Pure gas precison testing

Plumbed long 50um capillary from live CO2 regulator to cage wall fitting.

### Leak detector flow tests

### Current vs flow and pressure

### Data vs flow

Took data on targets 6 and 7 at various CO2 flow rates.

Data summary

```{r}
data <- get_hgis_data(here("Data/USAMS120320R.txt"), as.Date("2021-01-08"))
ds <- sum_hgis(data)
ds
```


```{r}
plot_hgis(data)
```

Took data for 4 different flows on target 6. CO2 flow data show ratio dependence on flow. Need to fill in data to get shape of curve. 
Current vs flow

```{r}
ds %>% 
  filter(Pos == 6) %>% 
  mutate(Pressure = as.numeric(str_extract(Sample.Name, "\\d+"))) %>% 
  ggplot(aes(Pressure, Cur)) +
  geom_pointrange(aes(ymin = Cur - Cur.sd, ymax = Cur + Cur.sd)) + 
  geom_point(size = 4)

```

Fm vs. Flow. Note that solid standards had a lot of variability, so treat ratio as relative, not well normalized.

```{r}
ds %>% 
  filter(Pos == 6) %>% 
  mutate(Pressure = str_extract(Sample.Name, "\\d+")) %>% 
  ggplot(aes(Cur, mean, shape = Pressure, color = Pressure)) +
  geom_pointrange(aes(ymin = mean - sd, ymax = mean + sd)) + 
  geom_point(size = 4)
```

