---
title: "Open Split Tests"
output:
  html_document:
    df_print: paged
    toc: true
  pdf_document: default
editor_options: 
  markdown: 
    wrap: 72
---

```{r, message=FALSE, warning=FALSE}
# Load libraries and functions
library(tidyverse)
library(amstools)
library(here)
library(HybridGIS)
library(broom)

theme_set(theme_bw())
options(digits = 3)
```

Development notes for using the HGIS with an open split. Intention is to
use with gasbench for carbonates and/or large co2 samples.

# Capillary parameters

Calculate ideal capillary to provide \~7.5uL/min at atmospheric
pressure.

## Short capillary at 1 atm

40um capillary

```{r}
r <- 2E-5
u <- 1.49E-5
x <- 3.5
flowcalc(100, r, u, x)
```

```{r}
r <- 2E-5
u <- 1.49E-5
x <- 2
flowcalc(100, r, u, x)
```

50um capillary

```{r}
r <- 2.5E-5
u <- 1.49E-5
x <- 3
flowcalc(100, r, u, x)
```

```{r}
r <- 2.5E-5
u <- 1.49E-5
x <- 7
flowcalc(100, r, u, x)
```

# First Tests

## 2018-04-10 - First tests

Tried a bunch of capillary combinations. Other than initial pressure
burst when opening or closing HGIS valve, couldn't see any source
pressure changes or beam current. We believe the source end of the
stainless capillary was clogged by cesium residue.

Cleaned capillary end at next source cleaning, first with kimwipe and
water, then with isopropanol. Lots of black crud. Confirmed open passage
by blowing N2 through capillary into cup of isopropanol to observe
bubbles.

## 2018-05-23 - First tests

Tried 3m of 50um glass capillary. Insulated from source to cage with
teflon tubing as outer jacket. No problems with sparks.

Low currents, even when cutting capillary down to 2m. Either steel
capillary is partially clogged or tip is not making good seal with
target.

## 2018-05-31 - He Dilution

Open split set up with helium dilution. Using 100um glass capillary.
\~50cm source to bulkhead with teflon jacket, 285cm bulkhead to open
split.

### Flows

```{r}
flowcalc(100, r = 2.5E-5, u = 1.49E-5, l = 3.35)
```

This is way too high. I may have been using a 50um capillary for the
tests.

### Pressures

| Condition    | Torr  |
|--------------|-------|
| base w/cryo  | 1E-7  |
| base w/turbo | 4E-7  |
| capillary    | 36E-7 |

: Source pressures

### Dilution and current

Flow and current tests with varying capillary and dilution. Flows in
mL/min, pressure in Torr, current in uA. Replumbed helium to panel open
split with needle valve partway through to better control flow. Live CO2
set to 10mL/min.

```{r}
osdil <- read_csv(here("data/2018-05-31_dillution.csv")) %>% 
  mutate(ratio = helium/co2)
osdil
```

```{r}
osdil %>% 
  filter(caplen == 322) %>% 
  ggplot(aes(ratio, current)) +
    geom_line() + 
    ggtitle("Current vs dillution ratio for 10 and 18 mL/m CO2") +
    facet_grid(co2 ~ .)
```

### Test Acquisitions

Ran 4 test Acquisitions with open split: pure CO2, pure dead CO2,
diluted live, diluted dead. Data are 14/12 ratio with a 13C correction
applied. NormFm is values normalized to the ratio of the solid OX-I.
There are also dual inlet samples on this wheel, filtered out by date.
Positions are incorrect in file because wheel was advanced manually.
Correct positions in notebook and fixed below. Added correct dilution
factors below.

```{r}
data <- get_hgis_data(here("data/USAMS053018R.txt"), 
                      as.Date(c("2018-05-30", "2018-05-31"))) %>% 
           filter(Pos %in% c(3,4) | as.Date(ts) == "2018-05-31") %>% 
           mutate(Pos = case_when(Sample.Name == "LiveGas" ~ 7,
                                  Sample.Name == "DeadGas" ~ 8,
                                  Sample.Name == "LiveGasHe" ~ 9,
                                  Sample.Name == "DeadGasHe" ~ 10,
                                  TRUE ~ as.numeric(Pos)),
                  dil_factor = case_when(Pos == 9 ~ (50.3 - 9.4)/9.4,
                                         Pos == 10 ~ (40 - 4.8)/4.8),
                  Num = ifelse(Pos %in% c(3, 4), "S", Num))

# Get mean ratio for solid OX-I and normalize data
stdrat <- mean(data$cor1412he[data$Num == "S" & !data$outlier])
data <- mutate(data, normFm = norm_gas(cor1412he, stdrat))
                  
sum_hgis(data)
```

```{r}
plot_hgis(data)
```

## 2019-05-31 - startup tests

Reinstalled gas delivery arm after cleaning and polishing ball end.

Using 50um x .5m capillary source to cage and 50um x 2.5m to open split.
Open split flowing modern co2 at 10mL/min. Using same targets and wheel
as last time. Surprisingly good performance, including no-gas base
current, hgis current and solid samples.

```{r}
flowcalc(pres = 100, r = 2.5E-5, u = 1.49E-5, l = 3.0)
```

Currents up to 15uA, source vac 8.3E-7 with gas on, 5.5E-7 with gas off.

No data recorded

## 2019-06-03 - dillution tests

Spun up inlet turbopump. Looked at dilution and current.

```{r}
dil <- tibble(
  CO2 = c(10, 10, 10, 10, 10),
  Tot = c(10, 20, 30, 43.5, 10),
  vac = c(1.24E-6, 9.52E-7, 8.3E-7, 8E-7, 1.07E-6),
  cur = c(10, 9.6, 7, 5, 10)
) %>% 
  mutate(He = Tot - CO2,
         ratio = He/CO2)
dil
```

```{r}
ggplot(dil, aes(ratio, cur)) +
  geom_line() +
  ggtitle("Current vs dillution ratio, CO2 at 10ml/min")
```

# Parameterization of source and open split

## 2020-09-10 Starting up HGIS

Solid run on pos 1:4 on USAMS012220.

## 2020-09-29 Dilution vs Ratio

Testing effect of helium dilution on ratio. Used remaining targets on
USAMS012220. Reterminated capillaries at cage wall and at open split.

Used positions 7-10, results in USAMS012220. Low currents: \~6uA pure
CO2, 3uA diluted. Flows: He 10, deadCO2 11, liveCO2 10.

```{r}
# Load data
data <- get_hgis_data(here("data/USAMS012220R.txt"), 
                      as.Date(c("2020-09-10", "2020-09-29"))) %>% 
           mutate(dil_factor = ifelse(str_starts(Sample.Name, "Dil"), 1, 0), 
                  Num = ifelse(Pos == 7, "U", Num))
stdrat <- mean(data$cor1412he[data$Num == "S" & !data$outlier])
data <- mutate(data, normFm = norm_gas(cor1412he, stdrat))
sum_hgis(data)
```

```{r}
plot_hgis(data)
```

Looks like diluted and undiluted live gas have the same ratio.

## 2020-10-15 New wheel, low currents

Loaded a new wheel (USAMS101320) with 4 solid targets and 6 gas targets.
Currents were low (3uA gas, 40uA solid) and didn't increase with tune,
target position or gas arm position. Will clean source and try again.

## 2020-11-03 Continued dillution tests

Still very low currents, \~2uA for live CO2. Ran a dillution test anyway
with positions 5-8 on USAMS101320.

**Flows**

| Gas  | Flow |
|------|------|
| live | 10   |
| dead | 11.1 |
| He   | 30.2 |

```{r}
data <- get_hgis_data(here("data/USAMS101320R.txt"), as.Date("2020-11-03"))
sum_hgis(data)
```

```{r}
plot_hgis(data)
```

## 2020-11-17 Dillution testing - back to good currents

Finally back to testing after figuring out current issue. Rerunning
dilution test. Flows: live 11.6mL/min, dead 11.1, He 30.2. Pressures:
cryo base 8E-8, turbo base 3E-7, w/live CO2 1.2E-6. Source producing
\~8uA HE12C with live CO2. Data in USAMS101320.

Running positions 9 and 10 as 1:1 He dilutions of live and dead,
respectively.

```{r}
data <- get_hgis_data(here("data/USAMS101320R.txt"), as.Date("2020-11-17"))
sum_hgis(data)
```

Look at counts per second to think about needed acquisition time.

```{r}
data %>% group_by(Sample.Name) %>% 
  summarize(cps = mean(CntTotGT/(Cycles/10)))
```

```{r}
plot_hgis(data)
```

```{r}
data %>% filter(Pos %in% 5:10) %>% 
  ggplot(aes(he12C, normFm, color = Sample.Name)) +
  geom_point()
```

Doesn't seem to follow curves expected for a MBC with nearly live blank
at about 1% of gas current.

## 2020-12-04 Blank tests

Ran a series of blank tests before exposing graphite samples or
introducing live co2.

Capillary break between Target blank and Helium blank. Replaced with SGE
100um x 52cm. Initial currents of targets are high, between 10-25uA.
Drops asymptotically to base target current in 5-10 minutes.

```{r}
data <- get_hgis_data(here("data/USAMS120320R.txt"), as.Date("2020-12-04"))
sum_hgis(data)
```

```{r}
plot_hgis(data)
```

### Modeling Blank

With these data we can start to think about modeling a mass balance, or
more accurately, a current balance blank. It's not initially clear
whether the blank comes from the target/source, diluent helium, or a
combination of the two.

```{r}
data %>% filter(Pos %in% 9:12) %>% 
  ggplot(aes(he12C, normFm, color = Sample.Name)) +
  geom_point() +
  ggtitle("Blank Fm vs. current")
```

If this blank follows the constant contamination model, plotting Fm vs.
inverse current should give a linear fit. Need more data here to confirm
fit and determine current and Fm of blank.

```{r}
# subset data
gas <- data %>% filter(Pos %in% 9:12) %>% mutate(icur = 1/he12C) 
# fit a linear model
fitlm <- lm(normFm ~ icur, data = gas)


# Add predicted values to data
gas$Fm = predict(fitlm)

ggplot(gas) +
  geom_line(aes(1/he12C, y = Fm)) +
  geom_point(aes(1/he12C, normFm, color = Sample.Name)) +
  ggtitle("Blank Fm vs. inverse current")

```

TODO: Fit mass balance curve using currents TODO: Use bottle gas to
produce live/dead curves TODO: produce live/dead curves using helium
dilution

## 2020-12-11 open split flow reduction

Testing reduced open split flows. Worked with flow controller (helium)
and adjusted stops on live and dead co2 needle valves to allow lower
flows. Tested for breakthrough by flowing helium through split and into
source while blowing dead CO2 across the opening of the split at
~10mL/min. CO2 seen in source somewhere between 100 and 300 uL/min.
Hard to measure with this setup due to slow response time and lack of
sensitivity of capillary/ion source. Need to try this with leak checker.

Reran blank tests at lower flows. Results seem as good or better than
last week's tests at high flows. This may also be due to targets being
more pumped down or burned in.

TODO: get flows from notes.

```{r}
data <- get_hgis_data(here("data/USAMS120320R.txt")) %>% 
  filter(Pos %in% 1:4 | as.Date(ts) == "2020-12-11") %>% 
  mutate(he = case_when(Pos == 9 ~ (1059 - 383),
                        Pos == 10 ~ 0,
                        Pos == 11 ~ 1370,
                        Pos == 12 ~ 0),
         co2 = case_when(Pos == 9 ~ 383,
                        Pos == 10 ~ 383,
                        Pos == 11 ~ 0,
                        Pos == 12 ~ 0),
         dil_rat = he/co2)
  
data %>% 
  group_by(Pos, Sample.Name, dil_rat) %>%
  summarise(Cur = mean(he12C),
            Cur.sd = sd(he12C),
            mean = mean(normFm),
            sd = sd(normFm),
            interr = 1/sqrt(sum(CntTotGT)),
            acqtime = sum(Cycles)/10,
            N_acq = n()) 
```

```{r}
plot_hgis(data)
```

```{r}
# subset data
gas <- data %>% filter(Pos %in% 9:12) %>% mutate(icur = 1/he12C) 
# fit a linear model
fitlm <- lm(normFm ~ icur, data = gas)


# Add predicted values to data
gas$Fm = predict(fitlm)

ggplot(gas) +
  geom_line(aes(1/he12C, Fm)) +
  geom_point(aes(1/he12C, normFm, color = Sample.Name)) +
  ggtitle("Blank Fm vs. inverse current")
```

## 2020-12-18 More testing of low open split flow rates

Tested open split breakthrough at low flows using leak checker. Measured
helium flow through capillary using leak checker. Ran target blanks,
dead and live samples at low flows. Started building double needle
testbed.

### Leak checker flow rate

Connected cage-split capillary to leak checker. Base leak rate with
capillary in air: 1.7E-9 mbarLs-1. Leak rate with helium in open split:
3.5E-4 mbarls-1. 

### Leak checker breakthrough tests

Flowing dead CO2 through split. Flowing helium across mouth of split at
8mLmin-1. Detection of helium means atmosphere is getting into split.

```{r}
lc_breakthrough <- tribble(~co2, ~leakrate,
                          730, 6E-9,
                          735, 6.5E-9,
                          525, 7.9E-9,
                          178, 1.3E-7,
                          150, 2E-7,
                          0, 3E-6)
lc_breakthrough
ggplot(lc_breakthrough, aes(co2, leakrate)) + geom_line() + geom_point() +
  ggtitle("Helium leak rate vs. CO2 flow to split")
```

### Data acquisitions at low(er) flows

Source off base: 4E-8 Cryo base (HV + Ion): 6E-8 Turbo base: 2E-7

Set SRS to 10uA/V and 50nA/V for 12 and 13C.

Flows:

```{r}
flows <- tribble(~pos, ~Sample.Name, ~co2, ~he,
                10, "DeadGas", 270, 0,
                9, "DilDeadGas", 112, 288,
                8, "DilDeadGas6", 102, 0,
                8, "DeadGas", 102, 572-102,
                7, "HeliumBlank", 0, 572-102,
                7, "DilLiveGas6", 117, 576-117) %>% 
  mutate(dil_ratio = he/co2)
flows
```

### Data

```{r}
data <- get_hgis_data(here("data/USAMS120320R.txt"), as.Date("2020-12-18"))
sum_hgis(data)
```

```{r}
plot_hgis(data)
```

```{r}
data %>% filter(Pos %in% 7:10) %>% 
  ggplot(aes(1/he12C, normFm, color = Sample.Name)) +
  geom_point() +
  ggtitle("Fm of live and dead samples vs. inverse current")
```

## 2021-01-08 Pure gas precison testing

Plumbed long 50um capillary from live CO2 regulator to cage wall
fitting. This allows controlling flow of CO2 to source using regulator pressure.

### Current vs flow and pressure

First test was with 748cm x 50 um capillary. Source base pressure using the cryopump was 2E-7 Torr. Base current for Pos 7 was 300uA. Initial max current @ 200kPA CO2 was 9uA. Did not return to this level in the pressure test following, not sure why, source pressure shows CO2 was getting to source. Typically best currents with pure CO2 are at a source pressure of around 1E-6 Torr. Reg pressure in kPa, source in Torr x 10-7 and current in uA.

```{r}
cur_vs_pres <- tribble(~regp, ~sourcep, ~c12cur,
                       0, 2.8, 0.8,
                       50, 3.3, 1,
                       100, 5.3, 1.2,
                       150, 8.2, 1.4,
                       200, 12, 1.8,
                       250, 17, 2.4,
                       300, 22, 3.1,
                       350, 28, 3.7,
                       400, 35, 4.5)
cur_vs_pres
```

Tested again with new capillaries after a clog in regulator-cage capillary and spark damage to cage-source capillary. New capillaries: reg-cage- 639cm x 50um, cage-source- 50cm x 50um. Base current 250nA.

```{r}
cur_vs_pres2 <- tribble(~regp, ~sourcep, ~c12cur,
                       25, 2, .25,
                       100, 4, 1.3,
                       150, 8.4, 6.3,
                       200, 12, 6.2,
                       250, 17, 6.2)
cur_vs_pres2
```

### Data vs flow

Took data on targets 6 and 7 at various CO2 flow rates.

#### Data summary

```{r}
data <- get_hgis_data(here("data/USAMS120320R.txt"), as.Date("2021-01-08"))
ds <- sum_hgis(data)
ds
```

```{r}
plot_hgis(data)
```

#### Ratio and current vs flow

Took data for 4 different flows on target 6. CO2 flow data show ratio
dependence on flow. Need to fill in data to get shape of curve. Current
vs flow

```{r}
ds %>% 
  filter(Pos == 6) %>% 
  mutate(Pressure = as.numeric(str_extract(Sample.Name, "\\d+"))) %>% 
  ggplot(aes(Pressure, Cur)) +
  geom_pointrange(aes(ymin = Cur - Cur.sd, ymax = Cur + Cur.sd)) + 
  geom_point(size = 4) +
  ggtitle("Fm of live CO2 vs. C12 current")

```

Fm vs. Flow. Note that solid standards had a lot of variability, so
treat ratio as relative, not well normalized.

```{r}
ds %>% 
  filter(Pos == 6) %>% 
  mutate(Pressure = str_extract(Sample.Name, "\\d+")) %>% 
  ggplot(aes(Cur, mean, shape = Pressure, color = Pressure)) +
  geom_pointrange(aes(ymin = mean - sd, ymax = mean + sd)) + 
  geom_point(size = 4) +
  ggtitle("Fm vs. C12 current for varying CO2 regulator pressure")
```

## 2021-01-15 Precision and vial tests

Used test vial setup to test pure CO2 precision and introduction of CO2
from vial by displacing with helium.

### Data 
```{r}
df <- get_hgis_data(here("data/USAMS120320R.txt"), as.Date("2021-01-15")) 
stdrat <- mean(df$cor1412he[df$pos_name == "8 - LiveGasOS" & !df$outlier])
df <- mutate(df, normFm = norm_gas(cor1412he, stdrat))
  
sum_hgis(df)
```

### Ratio and current during runs

```{r}
plot_hgis_time(df) +
  facet_wrap(vars(pos_name), scales = "fixed")

ggplot(df, aes(cum_acqtime, he12C )) +
  geom_point() + 
  facet_wrap(vars(pos_name), scales = "fixed")
```

#### Ratio dependence on current

```{r}
ggplot(df, aes(he12C, normFm, color = pos_name)) +
  geom_point() +
  ggtitle("Fm of modern CO2 vs. C12 current")
```

```{r}
ggplot(df, aes(1/he12C, normFm, color = pos_name)) +
  geom_point() +
  ggtitle("Fm of modern CO2 vs. inverse C12 current")
```

Question: Is ratio current depletion change in CO2 from vial or target
degradation? Long pure CO2 run to test.

## 2021-01-22 Pure gas precison testing

Plumbed long 50um capillary from Valco valve to cage wall fitting.
Plumbed dead CO2 to Valco with 1/16" ss.

Took data with dead CO2 on target 5 at various CO2 flow rates. Same with
liveCO2 on target 6. Source not performing well, low currents and
current did not correspond well to CO2 pressure/flow. Current vs ratio
data may still be useful for blank model. Solid currents good, so this
is a gas issue. Gas blank also not great.

### Data summary

```{r}
data <- get_hgis_data(here("data/USAMS012121R.txt"), as.Date("2021-01-22"))
ds <- sum_hgis(data)
ds
```

Note that solid standards had a lot of variability, so
treat ratio as relative, not well normalized.

```{r}
plot_hgis(data)
```

#### Relationship of current and ratio to CO2 flow rate

##### Current vs flow

Supply pressure is proportional to flow rate.

```{r}
ds <- ds %>% 
  filter(Pos %in% c(5, 6)) %>% 
  mutate(Cur_inv = 1/Cur,
         Pressure = as.numeric(str_extract(Sample.Name, "\\d+")),
         Gas = ifelse(Pos == 5, "DeadCO2", "LiveCO2"))
  
ggplot(ds, aes(Pressure, Cur, color = Gas)) +
  geom_pointrange(aes(ymin = Cur - Cur.sd, ymax = Cur + Cur.sd)) + 
  geom_point(size = 4) +
  ggtitle("C12 current vs. CO2 regulator pressure")

```

##### Fm vs. current and flow rate


```{r}
ggplot(ds, aes(Cur, mean, color = Pos)) +
  geom_pointrange(aes(shape = factor(Pressure), ymin = mean - sd, ymax = mean + sd)) +
  ggtitle("Fm of live and dead gas vs C12 current")
```

### Modelling current dependent blank

#### Fit linear models

```{r}
fits <- ds %>% 
  ungroup() %>% 
  nest(data = -Gas) %>% 
  mutate(fit = map(data, ~lm(mean ~ Cur_inv, data = .x)),
         tidied = map(fit, tidy)) %>% 
  unnest(tidied) 

fits %>% 
  select(Gas, term, estimate) %>% 
  pivot_wider(names_from = c(Gas, term), values_from = estimate) %>% 
  mutate(inv_m_blank = -(`DeadCO2_(Intercept)` - `LiveCO2_(Intercept)`)/(DeadCO2_Cur_inv - LiveCO2_Cur_inv),
         Fm_blank = `DeadCO2_(Intercept)` + DeadCO2_Cur_inv * inv_m_blank,
         m_blank = 1/inv_m_blank) %>% 
  select(Fm_blank, m_blank)
```

#### Fm vs. inverse mass with fits.

```{r}
ggplot(ds, aes(Cur_inv, mean, color = Pos)) +
  geom_pointrange(aes(shape = factor(Pressure), ymin = mean - sd, ymax = mean + sd)) + 
  geom_smooth(method = "lm", fullrange = TRUE) +
  xlim(0, 5) +
  ggtitle("Fm of live and dead CO2 vs. inverse 12C current",
          subtitle = "Fit lines should cross at Fm and current of blank")
```

For these measurements, it looks like the blank is roughly 225nA at half
modern. This is higher current and lower Fm than expected based on
previous measurements. This is in line with the high blanks seen when
measuring dead carbon.

# Gas delivery from vials

## 2021-01-29 Reproducibility between multiple vials

Measured live and dead CO2 from vials. "STD" samples were displaced to
split with flowing CO2, while the "V" samples were displaced by helium
as they would be for unknowns. All samples measured on fresh targets
after a 5 minute "burn in" to reduce blank.

### Gas flows

Replaced capillary from Valco valve to double needle with longer piece
of 50um capillary. Set helium and CO2 flows.

+----------------------+-----------------------+-----------------------+
| Gas                  | Pressure (kPa)        | Flow (uL/min)         |
+======================+=======================+=======================+
| LiveCO2              | 165                   | 136                   |
+----------------------+-----------------------+-----------------------+
| DeadCO2              | 160                   | 120                   |
+----------------------+-----------------------+-----------------------+
| Helium               | 165                   | 115                   |
+----------------------+-----------------------+-----------------------+

: Gas flow rates

Measured split to cage wall capillary flow with leak checker. Leak rate: 1.0E-5 Pa m^3/s.

### Data

Normalizing to solid OX-I's. 

```{r}
data <- get_hgis_data(here("data/USAMS012121R.txt"), as.Date("2021-01-29")) %>% 
  mutate(Num = ifelse(Pos %in% c(7, 9), "U", Num))
```

#### Currents and ratios vs time.

Sample ratio vs. time

```{r}
plot_hgis_time(data, cor1412he, ce*cor1412he)
```

Sample current vs time

```{r}
plot_hgis_time(data, he12C)
```


```{r}
# Get mean ratio for solid OX-I and normalize data
stdrat <- mean(data$cor1412he[data$Num == "S" & !data$outlier])
data <- mutate(data, normFm = norm_gas(cor1412he, stdrat))
```

#### Per-sample summary

```{r}
ds <- data %>% 
  filter(!outlier) %>% 
  sum_hgis()
ds
```

```{r}
plot_hgis(data)
```


### Agreement of replicates

Summary statistics to look at reproducibility between targets/vials.

```{r}
ds %>% 
  filter(as.numeric(Pos) > 4,
         Pos != 9) %>%  # Don't use bad target
  mutate(gas = ifelse(str_starts(Sample.Name, "Live"), "Live", "Dead"),
         helium = ifelse(str_detect(Sample.Name, "V\\d$"), TRUE, FALSE)) %>% 
  group_by(gas, helium) %>% 
  summarize(Fm.mean = mean(mean),
            Fm.sd = sd(mean),
            N = n())
```

It looks like the SD of modern samples is around 1%, and that pure CO2 performs slightly better than helium displacement.

## 2021-02-05 Carbonate samples

Measured carbonate samples prepared on gasbench. Samples included C-1, TIRI-F, TIRI-I, C-2, and NOSAMS2. Normalized to gas standards or solid OX-I.

First carbonate sample clogged capillary. Capillary replaced, moved needle up to avoid sucking in acid. Was not able to get good currents after replacing capillary, even trying several length/capillary combinations. Source vacuum indicates normal amount of gas entering source. May need to consider a water trap. All samples measured on fresh targets after a 5 minute "burn in" to reduce blank.

### Samples

```{r}
carb_data <- tribble(~vial, ~name, ~rec_num, ~mass,
                     1, "C-1", 83028, 32.05,
                     2, "TIRI-F", 2138, 33.56,
                     3, "TIRI-I", 17185, 32.67,
                     4, "TIRI-I", 17185, 32.35,
                     5, "C-2", 1082, 31.35,
                     6, "C-2", 1082, 34.11,
                     7, "NOSAMS2", 38809, 32.30,
                     8, "NOSAMS2", 38809, 34.00
                     )

write_csv(carb_data, here("data/carb_data_2021-02-05.csv"))
carb_data
```


### Gas flows

Set helium and CO2 flows.

+----------------------+-----------------------+-----------------------+
| Gas                  | Pressure (kPa)        | Flow (uL/min)         |
+======================+=======================+=======================+
| LiveCO2              | 150                   | 95                    |
+----------------------+-----------------------+-----------------------+
| Helium               | 150                   | 97                    |
+----------------------+-----------------------+-----------------------+

: Gas flow rates

### Data

Normalizing to gas standards in pos 5 and 8. 

```{r}
data <- get_hgis_data(here("data/USAMS020521R.txt")) %>% 
  mutate(Num = ifelse(Pos %in% c(2, 4), "U", Num))
```

#### Currents and ratios vs time.

Sample ratio vs. time

```{r}
plot_hgis_time(data, cor1412he, ce*cor1412he)
```

Sample current vs time

```{r}
plot_hgis_time(data, he12C)
```

#### Normalization

```{r}
# Get mean ratio for solid OX-I and normalize data
stdrat <- mean(data$cor1412he[data$Num == "S" & !data$outlier])
data <- data %>% 
  mutate(normFm = norm_gas(cor1412he, stdrat),
         Fm_bc = doMBC(normFm, 0.6, he12C, 0.1 ))
```

#### Summary of normalized data per sample

```{r}
ds <- data %>% 
  filter(!outlier) %>% 
  sum_hgis() %>% 
  mutate(rec_num = case_when(str_starts(Sample.Name, "LiveGas") ~ 101730,
                             Sample.Name == "C-1" ~ 83028,
                             Sample.Name == "TIRI-F" ~ 2138,
                             Sample.Name == "TIRI-I" ~ 17185,
                             Sample.Name == "C-2" ~ 1082,
                             Sample.Name == "NOSAMS2" ~ 38809))

std <- getStdTable()

ds <- left_join(ds, select(std, rec_num, fm_consensus)) %>% 
  mutate(fm_consensus = ifelse(rec_num == 101730, 1.0398, fm_consensus))

ds[-(1:4),-3]
```

```{r}
data %>% 
  filter(as.numeric(Pos) > 4) %>% 
  ggplot(aes(pos_name, normFm)) +
  geom_boxplot(fill = "slategray1") +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) 
```


### Agreement of replicates

Summary statistics to look at reproducibility, accuracy between targets/vials.

```{r}
ds %>% 
  filter(as.numeric(Pos) > 4,
         Pos != 6) %>% # Don't use bad target
  mutate(Name = ifelse(Pos %in% c(5,8), "LiveGas", Sample.Name)) %>% 
  group_by(Name, fm_consensus) %>% 
  summarize(Fm.mean = mean(mean),
            Fm.sd = sd(mean),
            Cur.mean = mean(Cur),
            N = n()) 
```

It looks like the SD of replicates of modern samples with current > 3uA is around 0.5%, which is better than measurement statistics. Fm of NOSAMS 2 is a bit high. Need to investigate current-dependent blank.

## 2021-03-01 Live gas and solid samples

Ran live CO2 from vial to check performance after source cleaning and cryopump issues. Slow to get going, so only one modern gas standard and solid samples run. Tried second modern gas standard on pos 16, but no current from gas that worked on pos 15. Bad target?

```{r}
data <- get_hgis_data(here("data/USAMS020521R.txt"), as.Date("2021-03-01"))
```

### Currents and ratios vs time.

Sample ratio vs. time

```{r}
plot_hgis_time(data, normFm, ce*normFm)
```

Sample current vs time

```{r}
plot_hgis_time(data, he12C)
```

### Normalization

```{r}
# Get mean ratio for solid OX-I and normalize data
stdrat <- mean(data$cor1412he[data$Num == "S" & !data$outlier])
data <- data %>% 
  mutate(normFm = norm_gas(cor1412he, stdrat))
```

### Summary of normalized data per sample

```{r}
ds <- data %>% 
  filter(!outlier) %>% 
  sum_hgis() %>% 
  mutate(rec_num = case_when(str_starts(Sample.Name, "LiveGas") ~ 101730,
                             Sample.Name == "C-1" ~ 83028,
                             Sample.Name == "TIRI-F" ~ 2138,
                             Sample.Name == "TIRI-I" ~ 17185,
                             Sample.Name == "C-2" ~ 1082,
                             Sample.Name == "NOSAMS2" ~ 38809))

std <- getStdTable()

ds <- left_join(ds, select(std, rec_num, fm_consensus)) %>% 
  mutate(fm_consensus = ifelse(rec_num == 101730, 1.0398, fm_consensus))

ds
```

```{r}
plot_hgis(data)
```